# Tinkoff Portfolio (Google Apps Script)

Инструменты для учёта портфеля в Google Sheets с данными из **Tinkoff Invest API v2**:
- обновление облигаций/фондов/акций/опционов;
- сводный лист **Dashboard** с графиками;
- еженедельный автоапдейт по триггеру;
- экспорт графиков и отправка отчёта в Telegram.

---

## Возможности
- `Input` — единая таблица входных идентификаторов:
  - **A**: FIGI облигаций  
  - **B**: FIGI фондов  
  - **C**: FIGI акций  
  - **D**: **UID опционов** (формат `uid:xxxxxxxx-...`)
- Листы `Bonds`, `Funds`, `Options` — обновление «только цены» и «полное».
- `Dashboard` — KPI, риски, секторная структура, сроки погашения, купоны (6 мес), топ-5 по YTM, просадка P/L по секторам и т.п.
- Экспорт диаграмм c `Dashboard` в PNG и отправка в Telegram.
- Команда `/start` бота — мгновенный Weekly-апдейт.

---

## Структура скриптов
- `main_menu.gs` — меню в Google Sheets (не менять).
- `ui.gs` — окна, панели, отладочные действия.
- `core.gs` — кэш, утилиты рендера/форматирования.
- `utils.gs` — конвертеры Quotation/MoneyValue/время.
- `tinkoff_api.gs` — обёртки Tinkoff API (Users, Instruments, MarketData, Operations).
- `input_loader.gs` — загрузка FIGI/UID из портфелей → `Input` (опционы как UID).
- `bonds_update.gs`, `funds_update.gs`, `options_update.gs` — листы с данными.
- `dashboard_bonds.gs` — построение `Dashboard` + секции с метриками.
- `dashboard_exports.gs` — экспорт диаграмм/секций и отправка в Telegram.
- `scheduler.gs` — еженедельные/ежемесячные триггеры и общий пайплайн.
- `tgbot_api.gs` — отправка сообщений/картинок и (опц.) вебхук бота.

---

## Требования
- Google аккаунт и Google Sheets.
- Токен Tinkoff Invest API (начинается с `t.`).
- (Опционально) Telegram-бот и чат ID.

---

## Быстрый старт
1. Создайте таблицу Google Sheets → **Расширения → Apps Script**.  
2. Вставьте файлы из репозитория (названия сохранять).  
3. Задайте токен:
   - Меню в таблице: **Тинькофф • Портфель → Настройки → Задать/сменить токен**,  
   или в **Script Properties** ключ `TINKOFF_TOKEN`.
4. Загрузите идентификаторы в `Input`:
   - **Тинькофф • Портфель → Данные → Загрузить FIGI в Input (все типы)**  
     (опционы попадут как `uid:...`).
5. Обновите листы:
   - **Облигации/Фонды/Опционы → Полное обновление**.
6. Постройте сводку:
   - **Сводка → Обновить Dashboard**.

---

## Автообновление
- Поставить еженедельный триггер (понедельник, 9:00):
```js
installWeeklyAutoRefresh(9)
